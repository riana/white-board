<!DOCTYPE html>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="./linked-graph.html">

<dom-module id="d3-board">

   <template>
      <style is="custom-style">
         :host {
            display: block;
         }

         #d3Board {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
         }
      </style>

      <iron-ajax auto url="/elements/d3-board/test.json" handle-as="json" on-response="handleResponse" debounce-duration="300"></iron-ajax>

      <div id="d3Board" on-tap="_addNode" on-track="_track">
      </div>
   </template>

   <script>
      "use strict";
      Polymer({
         is: "d3-board",
         ready() {
            this.linkedGraph = new LinkedGraph("#d3Board");
            this.linkedGraph.pencilFilter = false;
         },
         handleResponse(e) {
            let data = e.detail.response;
            this.linkedGraph.updateGraph(data);
            let updateCounter = 0;
            this.data = data;
            let updateTask = setInterval(() => {
               data.nodes[0].x = data.nodes[0].x + 40;
               updateCounter++;

               if (updateCounter == 5) {
                  data.nodes.push({
                     id: "2",
                     text: "new Node",
                     x: 100,
                     y: 250
                  })

                  data.links.push({
                     source: "1",
                     target: "2"
                  });
               }

               if (updateCounter >= 10) {

                  data.nodes.splice(0, 1);
                  data.links.splice(0, 1);
               }
               if (updateCounter >= 10) {
                  clearInterval(updateTask);
               }
               this.linkedGraph.updateGraph(data);
            }, 100);
         },
         _addNode(e) {
            if(!this.id){
               this.id = 2;
            }
            this.id++;
            let newId = this.id;
            let newNode = {
               id: "" + newId,
               text: "new Node",
               x: e.detail.x,
               y: e.detail.y
            };
            this.data.nodes.push(newNode);

            let link = {
               source: newId,
               target: "1"
            };
            this.data.links.push(link);

            this.linkedGraph.updateGraph(this.data);
         },
         _track(e) {
            console.log(e);
         }


      });
   </script>

</dom-module>
