<!DOCTYPE html>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="./board-storage.html">
<link rel="import" href="./board-toolbar.html">
<link rel="import" href="./board-surface.html">
<link rel="import" href="./board-selector.html">
<link rel="import" href="./UUID.html">

<link rel="import" href="../fa-button/fa-button.html">
<link rel="import" href="../backdrop-view/backdrop-view.html">

<dom-module id="board-app">
    <template>
        <!-- TODO fix layout -->
        <style is="custom-style">
            :host {
                display: block;
                @apply(--layout-vertical);
            }

            #controlBar {
                background: var(--paper-grey-800);
                padding-top: 10px;
            }

            .add-button {
                margin: 4px;
                cursor: copy;
            }

            .add-button > * {
                pointer-events: none;
            }

            .controls-container {
                margin-bottom: 20px;
            }

            fa-button {
                color: var(--paper-grey-100);
            }
        </style>

        <board-storage id="storage" on-loaded="_loaded" board-index="{{boardsIndex}}"></board-storage>

        <board-toolbar title="{{boardContent.title}}" on-save="_save" on-open="_open" on-create="_createBoard"></board-toolbar>
        <div class="layout horizontal flex">
            <div id="controlBar" class="layout vertical center">
                <div class="controls-container">
                    <fa-button icon="fa-mouse-pointer"></fa-button>
                    <fa-button icon="fa-image" on-tap="_insertImage"></fa-button>
                </div>

                <fa-button icon="fa-font" draggable="true" on-track="_onDropText"></fa-button>
                <template is="dom-repeat" items="[[stickStyles]]" as="stickStyle">
                    <paper-material elevation="2" class="add-button" draggable="true" on-track="_onDropStick">
                        <paper-icon-button icon="editor:short-text" style$="{{_getAddStickStyle(stickStyle)}}" no-ink></paper-icon-button>
                    </paper-material>
                </template>
            </div>
            <board-surface id="board" class="flex" data="{{boardContent}}" on-drop="_handleDrop" on-media-removed="_mediaRemoved"></board-surface>
        </div>
        <backdrop-view id="loadDialog">
            <board-selector boards="[[boardsIndex]]" on-load="_loadBoard" on-delete="_delete"></board-selector>
        </backdrop-view>
    </template>

    <script>
        "use strict";
        Polymer({
            is: "board-app",
            properties: {
                boardsIndex: {
                    type: Array,
                    value: []
                },
                boardContent: {
                    type: Object,
                    value: {
                        title: "My Board",
                        nodes: [],
                        links: [],
                        images: []
                    }
                },
                stickStyles: {
                    type: Array,
                    value: [{
                        name: "white",
                        color: "#000000",
                        background: "#FFFFFF"
                    }, {
                        name: "yellow",
                        color: "#000000",
                        background: "#FFEB3B"
                    }, {
                        name: "blue",
                        color: "#FFFFFF",
                        background: "#039BE5"
                    }, {
                        name: "green",
                        color: "#FFFFFF",
                        background: "#689F38"
                    }, {
                        name: "purple",
                        color: "#FFFFFF",
                        background: "#7E57C2"
                    }, {
                        name: "red",
                        color: "#FFFFFF",
                        background: "#F44336"
                    }, {
                        name: "orange",
                        color: "#FFFFFF",
                        background: "#EF6C00"
                    }]
                }
            },
            attached() {
                // this.$.storage.load(selected);
                this.$.board.ondragover = (e) => {
                    this._dragOver(e)
                    return false;
                };
                this._createBoard();
            },
            _loaded(e) {
                let data = e.detail;
                if (data) {
                    if (!data.images) {
                        data.images = [];
                    }
                    data.images.forEach(image => {
                        this.$.storage.getImage(data.id, image, (resp) => {
                            console.log("#image loaded : ", typeof(resp));
                            let content = resp;
                            this.$.board.addMedia(image.id, content);

                        })
                    });
                    this.boardContent = data;
                }
            },
            _save() {
                this.$.storage.save(this.boardContent);
            },
            _open() {
                this.$.storage.loadBoardsIndex();
                this.$.loadDialog.open();
            },
            _delete(e) {
                this.$.storage.delete(e.detail);
            },
            _loadBoard(e) {
                this.$.storage.updateIndex(e.detail);
                this.$.storage.load(e.detail.id);
                this.$.loadDialog.close();
            },
            _mediaRemoved(e) {
               let imageItem = e.detail;
               this.$.storage.deleteImage(this.boardContent.id, imageItem.id, (status)=>{
                  if(!status){
                     this._save();
                  }
               });
            },
            _createBoard() {
                this.boardContent = {
                    id: UUID.generate(),
                    title: "Untitled",
                    nodes: [],
                    links: [],
                    images: []
                };
            },
            _addNode(newNode, e) {

                let defaultWidth = 80;
                let defaultHeight = 80;

                let pos = this.$.board.getPositionOnBoard(e.detail.x, e.detail.y);

                newNode.id = UUID.generate();
                newNode.text = "Put your text here";
                newNode.x = pos.x - (defaultWidth / 2);
                newNode.y = pos.y - (defaultHeight / 2);
                newNode.width = defaultHeight;
                newNode.height = 39;

                this.boardContent.nodes.push(newNode);
                this.$.board._dataUpdated();

                this.$.board.editNode(newNode, {
                    x: e.detail.x - (defaultWidth / 2),
                    y: e.detail.y - (defaultHeight / 2)
                });
            },
            _onDropStick(e) {
                if (e.detail.state === 'end') {
                    let newNode = {
                        style: e.model.stickStyle
                    };
                    this._addNode(newNode, e);
                }
            },
            _onDropText(e) {
                if (e.detail.state === 'end') {
                    let newNode = {
                        type: "text"
                    };
                    this._addNode(newNode, e);
                }
            },
            _getAddStickStyle(stickStyle) {
                return `background: ${stickStyle.background}; color: ${stickStyle.color};`;
            },
            _insertImage() {
                console.log("_insertImage");
            },
            _handleDrop(e) {
                e.preventDefault();
                var file = e.dataTransfer.files[0],
                    reader = new FileReader();

                //   file.type.lastIndexOf("video/")
                console.log("file type : ", file.type, file.type.lastIndexOf("image/"));

                reader.onload = (event) => {
                    console.log(e);
                    let position = this.$.board.getPositionOnBoard(e.offsetX, e.offsetY);
                    let imageData = event.target.result;

                    var img = new Image;
                    img.onload = () => {
                        let imageTest = {
                            id: UUID.generate(),
                            type: file.type,
                            x: position.x,
                            y: position.y,
                            width: img.width,
                            height: img.height,
                            rotation: 0
                        };

                        this.$.storage.saveImage(this.boardContent.id, imageTest.id, file, (resp) => {
                            console.log("## Media refresh");
                            this.$.board.addMedia(imageTest.id, imageData);
                            this.boardContent.images.push(imageTest);
                            this.$.board._dataUpdated();
                            this._save();
                        }, imageData);
                    };
                    img.src = imageData;
                };
                reader.readAsDataURL(file);
                return false;
            },
            _dragOver(e) {
                return false;
            }
        });
    </script>

</dom-module>
