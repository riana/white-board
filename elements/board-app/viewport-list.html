<!DOCTYPE html>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<!--Imports go here-->

<dom-module id="viewport-list">

    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment">
            :host {
                display: block;
                background: var(--paper-grey-300);
            }

            iron-image {
                width: 128px;
                height: 72px;
                margin: 8px;
                background: white;
            }
        </style>

        <div class="layout horizontal center">
            <paper-button on-tap="_addViewport">Add Viewport</paper-button>
        </div>
        <template is="dom-repeat" items="[[boardContent.viewports]]" as="viewport">
            <div on-tap="_restoreViewport" class="layout vertical center">
                <iron-image src="[[viewport.screenShot]]" sizing="contain"></iron-image>
            </div>
        </template>

    </template>

    <script>
        "use strict";
        Polymer({
            is: "viewport-list",
            properties: {
                boardContent: {
                    type: Object,
                    observer: "_boardContentChanged"
                }
            },
            _boardContentChanged(newValue) {
                if (!newValue.viewports) {
                    // newValue.viewports = [];
                    this.set("boardContent.viewports", []);
                }

            },
            _addViewport() {
                let newViewport = JSON.parse(JSON.stringify(this.boardContent.view));
                this.getHtmlContent(screenShot => {
                    newViewport.screenShot = screenShot;
                    this.push("boardContent.viewports", newViewport);
                });


            },
            _restoreViewport(e) {
                this.fire("restore-viewport", e.model.viewport)
            },
            getHtmlContent(cb) {
                let svg = document.getElementById("SVGBoard");
                let serializer = new XMLSerializer();
                let str = serializer.serializeToString(svg);
                var canvas = document.getElementById('canvasBoard');
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                var encodedData = window.btoa(str);

                var image = new Image();
                image.setAttribute('crossOrigin', 'anonymous');

                image.onload = function() {
                    ctx.drawImage(image, 0, 0);
                    let screenShot = canvas.toDataURL();
                    cb(screenShot);

                };

                image.src = 'data:image/svg+xml;base64,' + encodedData;

            },

            testImage(cb) {
                let svg = document.getElementById("SVGBoard");
                let serializer = new XMLSerializer();
                let str = serializer.serializeToString(svg);
                console.log(str);

                var canvas = document.getElementById('canvasBoard');
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                var data = str;



                var DOMURL = window.URL || window.webkitURL || window;

                var img = new Image();



                var svgData = new Blob([data], {
                    type: 'image/svg+xml;charset=utf-8'
                });
                var url = DOMURL.createObjectURL(svgData);

                img.onload = function() {
                    img.setAttribute('crossOrigin', 'Anonymous');
                    ctx.drawImage(img, 0, 0);
                    DOMURL.revokeObjectURL(url);
                    let screenShot = canvas.toDataURL();
                    cb(screenShot);
                }
                img.src = url;
            }
        });
    </script>

</dom-module>
